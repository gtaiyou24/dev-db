# 応用的なデータ検索

## 副問合せ
> 副問合せは、別のSQL文の中に埋め込まれているSELECT文である。
```sql
SELECT 列リスト
FROM テーブル名
WHERE 列名 比較演算子 ( SELECT 列名 FROM テーブル名 )
;
```

> - 副問合せの使用箇所
>     - WHERE句
>     - HAVING句
>     - FROM句
> - 副問合せは括弧`()`で囲む
> - 主問合せの前に1度だけ実行される
> - 副問合せのネストの数は任意ですが、一番深いレベルの副問合せから実行される

ex) 従業員表からAbeと同じ部署に所属する従業員を検索
```sql
SELECT last_name, dept_id 
FROM emp
WHERE dept_id = ( 
		SELECT dept_id
	    FROM emp
	    WHERE last_name = 'Abe'
    )
;
```

副問合せから、1行のみを戻す副問合せを「**単一行副問合せ**」、複数行を戻す問合せを「**複数行副問合せ**」といいます。

### 単一行副問合せ
> 一行のみを戻す副問合せ
> 
> 単一行副問合せで使用する演算子
>
| 比較演算子 | 説明 |
|:------|:-----|
| `=` | 等しい |
| `<>` | 等しくない |
| `>` | より大きい |
| `>=` | 以上 |
| `<` | より少ない |
| `<=` | 以下 |

### 複数行副問合せ
> 複数行を戻す副問合せ
> 
> 複数行副問合せで使用する演算子

| 比較演算子 | 説明 |
|:------|:-----|
| `IN` | リスト内のいずれかの値と等しい |
| `ANY` | 値を戻された各値と比較 |
| `ALL` | 値を戻されたすべての値と比較 |

> ANY/ALL演算子は、単一行副問合せで使用される演算子と組み合わせて使用する

| 比較演算子 | 説明 |
|:------|:-----|
| `> ANY` | 最小値よりも大きい |
| `>= ANY` | 最小値以上 |
| `< ANY` | 最大値よりも小さい |
| `<= ANY` | 最大値以下 |
| `= ANY` | INと同じ意味 |
| `> ALL` | 最大値よりも大きい |
| `>= ALL` | 最大値以上 |
| `< ALL` | 最小値よりも小さい |
| `<= ALL` | 最小値以下 |
| `<> ALL`, `NOT ALL` | すべてと等しくない |


---
## 内部結合
2つのテーブルで対応する列の値を比較し、共通の値に従って行が結合される。

```sql
SELECT 列リスト
FROM テーブル名1
JOIN テーブル名2
ON [テーブル名1.]列名 = [テーブル名2.]列名;
# or
SELECT 列リスト
FROM テーブル名1, テーブル名2
WHERE [テーブル名1.]列名 = [テーブル名2.]列名;
```

特殊な結合

 1. インラインビューの結果と結合する : FROM句・JOIN句に副問合せを使用する
 2. 非等価結合 : ex)`ON 列名1 > 列名1`

**3つ以上のテーブルの結合**<br>
```sql
SELECT 列リスト
FROM テーブル名1
JOIN テーブル名2
ON [テーブル名1.]列名 = [テーブル名2.]列名
JOIN テーブル名3
ON [テーブル名3.]列名 = [テーブル名1またはテーブル名2.]列名;

# or 

SELECT 列リスト
FROM テーブル名1, テーブル名2, テーブル名3
WHERE [テーブル名1.]列名 = [テーブル名2.]列名
AND [テーブル名3.]列名 = [テーブル名1またはテーブル名2.]列名;
```

**自己結合**<br>
結合を同じテーブル同士で行う。
```sql
SELECT 列リスト
FROM テーブル名 別名1
JOIN テーブル名 別名2
ON 別名1.列名 = 別名2.列名;
```

## 外部結合
外部結合では、結合条件を満たす行とともに、結合条件を満たさない行も一緒に表示することができる。

**左側外部結合**<br>
```sql
SELECT 列リスト
FROM テーブル名1
LEFT [OUTER] JOIN テーブル名2
ON [テーブル名1.]列名 = [テーブル名2.]列名;
```

**右側外部結合**<br>
```sql
SELECT 列リスト
FROM テーブル名1
RIGHT [OUTER] JOIN テーブル名2
ON [テーブル名1.]列名 = [テーブル名2.]列名;
```

## クロス結合
クロス結合は、対象テーブルのすべての行の組み合わせが表示される結合
```sql
SELECT 列リスト
FROM テーブル名1
CROSS JOIN テーブル名2;
# or 
SELECT 列リスト
FROM テーブル名1, テーブル名2;
```

 - 結果件数は、「テーブル名1の行数×テーブル名2の行数」
 - 最初のテーブルの行データが2番目のテーブルのすべての行に結合される

## 集合演算

**UNION**<br>
複数の問合せの結果から、重複を排除したすべての行を表示

```sql
SELECT 列リスト
FROM テーブル名1 ...
UNION
SELECT 列リスト
FROM テーブル名2 ...;
```

**UNION ALL**<br>
複数の問合せの結果から、重複を含めてすべての行を表示する。まとめた結果に重複する行が存在しない場合でも、その重複は排除せずに表示する。

```sql
SELECT 列リスト
FROM テーブル名1 ...
UNION ALL
SELECT 列リスト
FROM テーブル名2 ...;
```

**集合演算を使用する際のポイント**<br>
集合演算を使用する場合、SELECT句に記述する列やソートについて注意する必要がある。

 - 各問合せの列 : 各問い合わせの列の数とデータ型は一致している必要がある。列の名前は一致している必要はありません。
 - ソート : ソートは全ての問い合わせの最後尾に記述する必要がある。



